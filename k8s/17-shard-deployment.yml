# --- Group A: Leader ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shard-a-leader
  namespace: lab2-microservices
  labels:
    app: shard-service
    group: group-a
    role: leader
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shard-service
      group: group-a
      role: leader
  template:
    metadata:
      labels:
        app: shard-service
        group: group-a
        role: leader
    spec:
      initContainers:
        - name: wait-for-router
          image: busybox:1.36
          command: [ 'sh', '-c', 'until wget -q -T 2 -O - http://router-service:8000/ >/dev/null 2>&1; do echo "Waiting for router-service..."; sleep 2; done;' ]
      containers:
        - name: shard-service
          image: lilarin/shard-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          command: [ "/bin/sh", "-c" ]
          args:
            - "export ADVERTISED_URL=http://$(POD_IP):8000 && uvicorn main:app --host 0.0.0.0 --port 8000"
          env:
            - name: ROUTER_SERVICE_URL
              value: "http://router-service:8000/api/v1"
            - name: KAFKA_BROKER_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: KAFKA_BROKER_URL
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            # Replication Config
            - name: SHARD_GROUP_ID
              value: "group-a"
            - name: IS_LEADER
              value: "true"
            - name: KAFKA_TOPIC
              value: "shard-a-log"
          resources:
            requests:
              cpu: "100m"
            limits:
              cpu: "200m"

---
# --- Group A: Followers ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shard-a-followers
  namespace: lab2-microservices
  labels:
    app: shard-service
    group: group-a
    role: follower
spec:
  replicas: 4
  selector:
    matchLabels:
      app: shard-service
      group: group-a
      role: follower
  template:
    metadata:
      labels:
        app: shard-service
        group: group-a
        role: follower
    spec:
      initContainers:
        - name: wait-for-router
          image: busybox:1.36
          command: [ 'sh', '-c', 'until wget -q -T 2 -O - http://router-service:8000/ >/dev/null 2>&1; do echo "Waiting for router-service..."; sleep 2; done;' ]
      containers:
        - name: shard-service
          image: lilarin/shard-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          command: [ "/bin/sh", "-c" ]
          args:
            - "export ADVERTISED_URL=http://$(POD_IP):8000 && uvicorn main:app --host 0.0.0.0 --port 8000"
          env:
            - name: ROUTER_SERVICE_URL
              value: "http://router-service:8000/api/v1"
            - name: KAFKA_BROKER_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: KAFKA_BROKER_URL
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            # Replication Config
            - name: SHARD_GROUP_ID
              value: "group-a"
            - name: IS_LEADER
              value: "false"
            - name: KAFKA_TOPIC
              value: "shard-a-log"
          resources:
            requests:
              cpu: "100m"
            limits:
              cpu: "200m"

---
# --- Group B: Leader ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shard-b-leader
  namespace: lab2-microservices
  labels:
    app: shard-service
    group: group-b
    role: leader
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shard-service
      group: group-b
      role: leader
  template:
    metadata:
      labels:
        app: shard-service
        group: group-b
        role: leader
    spec:
      initContainers:
        - name: wait-for-router
          image: busybox:1.36
          command: [ 'sh', '-c', 'until wget -q -T 2 -O - http://router-service:8000/ >/dev/null 2>&1; do echo "Waiting for router-service..."; sleep 2; done;' ]
      containers:
        - name: shard-service
          image: lilarin/shard-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          command: [ "/bin/sh", "-c" ]
          args:
            - "export ADVERTISED_URL=http://$(POD_IP):8000 && uvicorn main:app --host 0.0.0.0 --port 8000"
          env:
            - name: ROUTER_SERVICE_URL
              value: "http://router-service:8000/api/v1"
            - name: KAFKA_BROKER_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: KAFKA_BROKER_URL
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            # Replication Config
            - name: SHARD_GROUP_ID
              value: "group-b"
            - name: IS_LEADER
              value: "true"
            - name: KAFKA_TOPIC
              value: "shard-b-log"
          resources:
            requests:
              cpu: "100m"
            limits:
              cpu: "200m"

---
# --- Group B: Followers ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shard-b-followers
  namespace: lab2-microservices
  labels:
    app: shard-service
    group: group-b
    role: follower
spec:
  replicas: 4
  selector:
    matchLabels:
      app: shard-service
      group: group-b
      role: follower
  template:
    metadata:
      labels:
        app: shard-service
        group: group-b
        role: follower
    spec:
      initContainers:
        - name: wait-for-router
          image: busybox:1.36
          command: [ 'sh', '-c', 'until wget -q -T 2 -O - http://router-service:8000/ >/dev/null 2>&1; do echo "Waiting for router-service..."; sleep 2; done;' ]
      containers:
        - name: shard-service
          image: lilarin/shard-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          command: [ "/bin/sh", "-c" ]
          args:
            - "export ADVERTISED_URL=http://$(POD_IP):8000 && uvicorn main:app --host 0.0.0.0 --port 8000"
          env:
            - name: ROUTER_SERVICE_URL
              value: "http://router-service:8000/api/v1"
            - name: KAFKA_BROKER_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: KAFKA_BROKER_URL
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            # Replication Config
            - name: SHARD_GROUP_ID
              value: "group-b"
            - name: IS_LEADER
              value: "false"
            - name: KAFKA_TOPIC
              value: "shard-b-log"
          resources:
            requests:
              cpu: "100m"
            limits:
              cpu: "200m"
